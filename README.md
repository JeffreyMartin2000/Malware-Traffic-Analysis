# Traffic Analysis with Wireshark
This writeup is based on an excercise in www.malware-traffic-analysis.net. In each exercise, you'll be provided with a pcap file and accompanying materials. The pcap file serves as a recorded traffic capture that can be thoroughly scrutinized in Wireshark to identify any issues. Mastering the skill of analyzing network traffic proficiently is essential for strengthening an organization's security. It equips security teams with the capability to uncover the underlying causes of problems and develop effective strategies for mitigation.
-
Lets start with what we are doing<img width="939" alt="malware traffic analysis overview image" src="https://github.com/JeffreyMartin2000/Malware-Traffic-Analysis/assets/129632324/027fc65f-b6d8-493a-98f1-4a0c31831e0d">

I opened the PCAP file in Wireshark and accessed the accompanying notes document. The notes document contains alerts indicating that the machine has been compromised or infected. We already have the answer for the last question. Based on the IDS alerts, what type of infection is this? ET TROJAN ABUSE.CH SSL Blacklist Malicious SSL certificate detected (Dridex). When I look this up, I get information on Dridex Malware. 

<img width="737" alt="alert notes" src="https://github.com/JeffreyMartin2000/Malware-Traffic-Analysis/assets/129632324/7ee4b822-93c6-491b-8417-9f82533c65e1">

When I open a new pcap file I want to identify the different connections, endpoints, and/or conversations.
We can do this by using the "Statistics" menu option
<img width="955" alt="endpoints" src="https://github.com/JeffreyMartin2000/Malware-Traffic-Analysis/assets/129632324/ab8fabea-4f7a-489a-b7b9-c3acbcb0013c">

Now that I have explored what connections we have, lets answer the first few questions.
What is the IP address of the infected Windows host?
What is the MAC address of the infected Windows host?
What is the host name of the infected Windows host?

We can do this by using the following command to easily find all three answers 
ip.addr==172.17.8.109 && (dhcp)


<img width="949" alt="first three questions" src="https://github.com/JeffreyMartin2000/Malware-Traffic-Analysis/assets/129632324/5ad6dcba-e423-4e7a-9e1b-533f59fde5fa">

The next question is, What is the Windows user account name for the infected Windows host?

So I looked through the packets to and from the victims machine and focused on anything that could indicate authentication. Whether it is SMB or Kerberos. I decided to look up some commands that might help me solve this issue. In Wireshark, the kerberos.CNameString filter is used to filter and display Kerberos traffic where the client's principal name (often a user account) is specified as a part of the Client Name (CName) within Kerberos tickets. So lets use this filter and see what we can find.

<img width="957" alt="Windows user account name for the infected Windows host" src="https://github.com/JeffreyMartin2000/Malware-Traffic-Analysis/assets/129632324/6a2b3fab-16ed-49b2-a699-be135586773b">

What is the SHA256 file hash of the Windows executable file sent to the infected Windows host?

When I saw this question I knew how to get a hash value for a file easy right? However lest find that file first. I decided to look back at the alerts and realized one of the alerts showed me this string of text. ET INFO Executable Retrieved With Minimal HTTP Headers. To get the hash value we need to extract this file first. We do this by using File>Export Objects>HTTP. And this is what is shows

<img width="742" alt="export http" src="https://github.com/JeffreyMartin2000/Malware-Traffic-Analysis/assets/129632324/64eac73f-4ade-43bf-90e1-c98125d18a49">
Like the alerts have showed us, that is the IP address of the malicious source. I click on the HTTP Object "actiV.bin", save the file, and apply it to the filter. To make sure the file is an executable, I right click a packet, and follow the TCP stream. "MZ" and "This program cannot be run in DOS mode". The "MZ" signature is also commonly associated with the DOS executable file format, which was used in MS-DOS and early versions of Microsoft Windows.

<img width="604" alt="This is exe because of MZ" src="https://github.com/JeffreyMartin2000/Malware-Traffic-Analysis/assets/129632324/68d12bc0-50e4-4017-901b-89a1aca7f322">

Now lets do a simple sha256 hash and virustotal on the hash of "actiV.bin".
<img width="728" alt="sha256 hash" src="https://github.com/JeffreyMartin2000/Malware-Traffic-Analysis/assets/129632324/9d88103c-60ec-4af7-8c85-ce382844c381">


<img width="1584" alt="virsutotal" src="https://github.com/JeffreyMartin2000/Malware-Traffic-Analysis/assets/129632324/1f012f83-6197-4cdf-8bd5-b5aa5faca68c">
